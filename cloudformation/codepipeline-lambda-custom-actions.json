{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"Launches an EC2 instance. Launches CodeDeploy application and deployment group. Uses CodeDeploy resources in creating a generic CodePipeline Stack",
   "Parameters":{
      "S3Bucket":{
         "Type":"String",
         "Description":"S3 bucket to use for artifacts. Just bucket Name; not URL. IAM user should have access to the bucket.",
         "Default":"stelligent-training-public"
      },
      "S3Key":{
         "Type":"String",
         "Description":"S3 key within S3Bucket.",
         "Default":"public/codepipeline/aws-codepipeline-s3-aws-codedeploy_linux.zip"
      }
   },
   "Resources":{
      "CustomActionsStack":{
         "Type":"AWS::CloudFormation::Stack",
         "Properties":{
            "TemplateURL":"https://s3.amazonaws.com/stelligent-training-public/public/codepipeline/codepipeline-custom-actions.json",
            "TimeoutInMinutes":"60"
         }
      },
      "LambdaCodePipelineExecutionPolicy":{
         "DependsOn":[
            "CodePipelineLambdaRole"
         ],
         "Type":"AWS::IAM::Policy",
         "Properties":{
            "PolicyName":"LambdaRolePolicy",
            "Roles":[
               {
                  "Ref":"CodePipelineLambdaRole"
               }
            ],
            "PolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Action":[
                        "logs:*"
                     ],
                     "Resource":[
                        "arn:aws:logs:*:*:*"
                     ]
                  },
                  {
                     "Effect":"Allow",
                     "Action":[
                        "codepipeline:PutJobSuccessResult",
                        "codepipeline:PutJobFailureResult"
                     ],
                     "Resource":[
                        "*"
                     ]
                  }
               ]
            }
         }
      },
      "CodePipelineLambdaRole":{
         "Type":"AWS::IAM::Role",
         "Properties":{
            "AssumeRolePolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "lambda.amazonaws.com"
                        ]
                     },
                     "Action":[
                        "sts:AssumeRole"
                     ]
                  }
               ]
            },
            "Path":"/"
         }
      },
      "CodePipelineLambdaDummy":{
         "Type":"AWS::Lambda::Function",
         "DependsOn":[
            "CodePipelineLambdaRole",
            "LambdaCodePipelineExecutionPolicy"
         ],
         "Properties":{
            "Code":{
               "S3Bucket":{
                  "Ref":"S3Bucket"
               },
               "S3Key":"Archive.zip"
            },
            "Role":{
               "Fn::GetAtt":[
                  "CodePipelineLambdaRole",
                  "Arn"
               ]
            },
            "Description":"Always return success",
            "Timeout":20,
            "Handler":"lambdadummy.handler",
            "Runtime":"nodejs",
            "MemorySize":128
         }
      },
      "CodePipelineStack":{
         "Type":"AWS::CodePipeline::Pipeline",
         "DependsOn":[
            "CustomActionsStack",
            "CodePipelineLambdaDummy"
         ],
         "Properties":{
            "DisableInboundStageTransitions":[
               {
                  "Reason":"Demonstration",
                  "StageName":"Production"
               }
            ],
            "RoleArn":{
               "Fn::Join":[
                  "",
                  [
                     "arn:aws:iam::",
                     {
                        "Ref":"AWS::AccountId"
                     },
                     ":role/AWS-CodePipeline-Service"
                  ]
               ]
            },
            "Stages":[
               {
                  "Name":"Source",
                  "Actions":[
                     {
                        "InputArtifacts":[

                        ],
                        "Name":"Source",
                        "ActionTypeId":{
                           "Category":"Source",
                           "Owner":"AWS",
                           "Version":"1",
                           "Provider":"S3"
                        },
                        "OutputArtifacts":[
                           {
                              "Name":"MyApp"
                           }
                        ],
                        "Configuration":{
                           "S3Bucket":{
                              "Ref":"S3Bucket"
                           },
                           "S3ObjectKey":{
                              "Ref":"S3Key"
                           }
                        },
                        "RunOrder":1
                     }
                  ]
               },
               {
                  "Name":"Commit",
                  "Actions":[
                     {
                        "InputArtifacts":[

                        ],
                        "Name":"Build",
                        "ActionTypeId":{
                           "Category":"Invoke",
                           "Owner":"AWS",
                           "Version":"1",
                           "Provider":"Lambda"
                        },
                        "OutputArtifacts":[

                        ],
                        "Configuration":{
                           "FunctionName":{
                              "Ref":"CodePipelineLambdaDummy"
                           },
                           "UserParameters":{
                              "Ref":"AWS::StackName"
                           }
                        },
                        "RunOrder":1
                     },
                     {
                        "InputArtifacts":[

                        ],
                        "Name":"UnitTest",
                        "ActionTypeId":{
                           "Category":"Invoke",
                           "Owner":"AWS",
                           "Version":"1",
                           "Provider":"Lambda"
                        },
                        "OutputArtifacts":[

                        ],
                        "Configuration":{
                           "FunctionName":{
                              "Ref":"CodePipelineLambdaDummy"
                           },
                           "UserParameters":{
                              "Ref":"AWS::StackName"
                           }
                        },
                        "RunOrder":2
                     },
                     {
                        "InputArtifacts":[

                        ],
                        "Name":"StaticAnalysis",
                        "ActionTypeId":{
                           "Category":"Invoke",
                           "Owner":"AWS",
                           "Version":"1",
                           "Provider":"Lambda"
                        },
                        "OutputArtifacts":[

                        ],
                        "Configuration":{
                           "FunctionName":{
                              "Ref":"CodePipelineLambdaDummy"
                           },
                           "UserParameters":{
                              "Ref":"AWS::StackName"
                           }
                        },
                        "RunOrder":1
                     }
                  ]
               },
               {
                  "Name":"Configure",
                  "Actions":[
                     {
                        "InputArtifacts":[

                        ],
                        "Name":"LaunchEnvironment",
                        "ActionTypeId":{
                           "Category":"Invoke",
                           "Owner":"AWS",
                           "Version":"1",
                           "Provider":"Lambda"
                        },
                        "OutputArtifacts":[

                        ],
                        "Configuration":{
                           "FunctionName":{
                              "Ref":"CodePipelineLambdaDummy"
                           },
                           "UserParameters":{
                              "Ref":"AWS::StackName"
                           }
                        },
                        "RunOrder":1
                     },
                     {
                        "InputArtifacts":[

                        ],
                        "Name":"EnvironmentTest",
                        "ActionTypeId":{
                           "Category":"Invoke",
                           "Owner":"AWS",
                           "Version":"1",
                           "Provider":"Lambda"
                        },
                        "OutputArtifacts":[

                        ],
                        "Configuration":{
                           "FunctionName":{
                              "Ref":"CodePipelineLambdaDummy"
                           },
                           "UserParameters":{
                              "Ref":"AWS::StackName"
                           }
                        },
                        "RunOrder":2
                     }
                  ]
               },
               {
                  "Name":"Deploy",
                  "Actions":[
                     {
                        "InputArtifacts":[

                        ],
                        "Name":"DeployApp",
                        "ActionTypeId":{
                           "Category":"Invoke",
                           "Owner":"AWS",
                           "Version":"1",
                           "Provider":"Lambda"
                        },
                        "OutputArtifacts":[

                        ],
                        "Configuration":{
                           "FunctionName":{
                              "Ref":"CodePipelineLambdaDummy"
                           },
                           "UserParameters":{
                              "Ref":"AWS::StackName"
                           }
                        },
                        "RunOrder":1
                     }
                  ]
               },
               {
                  "Name":"Test",
                  "Actions":[
                     {
                        "InputArtifacts":[

                        ],
                        "Name":"AcceptanceTest",
                        "ActionTypeId":{
                           "Category":"Invoke",
                           "Owner":"AWS",
                           "Version":"1",
                           "Provider":"Lambda"
                        },
                        "OutputArtifacts":[

                        ],
                        "Configuration":{
                           "FunctionName":{
                              "Ref":"CodePipelineLambdaDummy"
                           },
                           "UserParameters":{
                              "Ref":"AWS::StackName"
                           }
                        },
                        "RunOrder":1
                     },
                     {
                        "InputArtifacts":[

                        ],
                        "Name":"ChaosTest",
                        "ActionTypeId":{
                           "Category":"Invoke",
                           "Owner":"AWS",
                           "Version":"1",
                           "Provider":"Lambda"
                        },
                        "OutputArtifacts":[

                        ],
                        "Configuration":{
                           "FunctionName":{
                              "Ref":"CodePipelineLambdaDummy"
                           },
                           "UserParameters":{
                              "Ref":"AWS::StackName"
                           }
                        },
                        "RunOrder":1
                     },
                     {
                        "InputArtifacts":[

                        ],
                        "Name":"SecurityTest",
                        "ActionTypeId":{
                           "Category":"Invoke",
                           "Owner":"AWS",
                           "Version":"1",
                           "Provider":"Lambda"
                        },
                        "OutputArtifacts":[

                        ],
                        "Configuration":{
                           "FunctionName":{
                              "Ref":"CodePipelineLambdaDummy"
                           },
                           "UserParameters":{
                              "Ref":"AWS::StackName"
                           }
                        },
                        "RunOrder":1
                     }
                  ]
               },
               {
                  "Name":"Production",
                  "Actions":[
                     {
                        "InputArtifacts":[

                        ],
                        "Name":"SwitchEndpoints",
                        "ActionTypeId":{
                           "Category":"Invoke",
                           "Owner":"AWS",
                           "Version":"1",
                           "Provider":"Lambda"
                        },
                        "OutputArtifacts":[

                        ],
                        "Configuration":{
                           "FunctionName":{
                              "Ref":"CodePipelineLambdaDummy"
                           },
                           "UserParameters":{
                              "Ref":"AWS::StackName"
                           }
                        },
                        "RunOrder":1
                     }
                  ]
               }
            ],
            "ArtifactStore":{
               "Type":"S3",
               "Location":{
                  "Ref":"S3Bucket"
               }
            }
         }
      }
   },
   "Outputs":{
      "StackName":{
         "Value":{
            "Ref":"AWS::StackName"
         }
      },
      "LambdaFunctionName":{
         "Value":{
            "Ref":"CodePipelineLambdaDummy"
         }
      }
   }
}