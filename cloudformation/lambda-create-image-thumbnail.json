{
  "AWSTemplateFormatVersion":"2010-09-09",
  "Description":"AWS CloudFormation for Image Thumbnail Lambda Function",
  "Parameters":{
    "S3Bucket":{
      "Description":"S3 Bucket used to store images.",
      "Type":"String",
      "Default":"pmd-lambda-functions",
      "AllowedPattern":"[\\x20-\\x7E]*",
      "ConstraintDescription":"Can contain only ASCII characters."
    }
  },
  "Resources":{
    "LambdaThumbnailRole":{
      "Type":"AWS::IAM::Role",
      "Properties":{
        "AssumeRolePolicyDocument":{
          "Version":"2012-10-17",
          "Statement":[
            {
              "Effect":"Allow",
              "Principal":{
                "Service":[
                  "lambda.amazonaws.com"
                ]
              },
              "Action":[
                "sts:AssumeRole"
              ]
            }
          ]
        },
        "Path":"/"
      }
    },
    "S3ImageThumbnailRole":{
      "Type":"AWS::Lambda::Permission",
      "Properties":{
        "Action":"lambda:InvokeFunction",
        "FunctionName":{
          "Fn::GetAtt":[
            "CreateThumbnailLambda",
            "Arn"
          ]
        },
        "Principal":"s3.amazonaws.com"
      }
    },
    "LambdaThumbnailExecutionPolicy":{
      "DependsOn":[
        "LambdaThumbnailRole"
      ],
      "Type":"AWS::IAM::Policy",
      "Properties":{
        "PolicyName":"LambdaRolePolicy",
        "Roles":[
          {
            "Ref":"LambdaThumbnailRole"
          }
        ],
        "PolicyDocument":{
          "Version":"2012-10-17",
          "Statement":[
            {
              "Effect":"Allow",
              "Action":[
                "logs:CreateLogGroup",
                "logs:CreateLogStream",
                "logs:PutLogEvents"
              ],
              "Resource":[
                "arn:aws:logs:*:*:*"
              ]
            },
            {
              "Effect":"Allow",
              "Action":[
                "s3:GetObject",
                "s3:PutObject"
              ],
              "Resource":[
                "arn:aws:s3:::*"
              ]
            }
          ]
        }
      }
    },
    "CreateThumbnailLambda":{
      "Type":"AWS::Lambda::Function",
      "DependsOn":[
        "LambdaThumbnailRole",
        "LambdaThumbnailExecutionPolicy"
      ],
      "Properties":{
        "Code":{
          "S3Bucket":{
            "Ref":"S3Bucket"
          },
          "S3Key":"Archive.zip"
        },
        "Role":{
          "Fn::GetAtt":[
            "LambdaThumbnailRole",
            "Arn"
          ]
        },
        "Description":"Create image thumbnail on upload to S3",
        "Timeout":20,
        "Handler":"createthumbnail.handler",
        "Runtime":"nodejs",
        "MemorySize":128
      }
    },
    "S3BucketEvent":{
      "Type":"AWS::S3::Bucket",
      "DependsOn":[
        "CreateThumbnailLambda",
        "S3ImageThumbnailRole"
      ],
      "Properties":{
        "BucketName":"pmd-lambda-images",
        "NotificationConfiguration":{
          "LambdaConfigurations":[
            {
              "Function":{
                "Fn::GetAtt":[
                  "CreateThumbnailLambda",
                  "Arn"
                ]
              },
              "Event":"s3:ObjectCreated:*"
            }
          ]
        }
      }
    },
    "S3Bucket2Event":{
      "Type":"AWS::S3::Bucket",
      "Properties":{
        "BucketName":"pmd-lambda-images-thumbnails"
      }
    }
  }
}