{
  "AWSTemplateFormatVersion":"2010-09-09",
  "Description":"Create S3 bucket and call stack to create SNS and Lambda resources ** This template creates one or more Amazon resources. You will be billed for the AWS resources used if you create a stack from this template.",
  "Parameters":{
    "AccessControl":{
      "Description":"AWS S3 bucket for aws",
      "Type":"String",
      "Default":"BucketOwnerFullControl"
    },
    "BucketName":{
      "Description":"AWS S3 bucket name for aws",
      "Type":"String",
      "Default":"opsworks-dist"
    },
    "MessageRetentionPeriod":{
      "Description":"AWS SQS Message retention period",
      "Type":"String",
      "Default":"12800"
    },
    "TopicName":{
      "Description":"SNS topic name for S3 subscription",
      "Type":"String",
      "Default":"aws-cfn-sns-topic"
    },
    "S3Event":{
      "Description":"SNS topic event to monitor for S3 subscription",
      "Type":"String",
      "Default":"s3:ObjectCreated:*"
    }
  },
  "Resources":{
    "SNSStack":{
      "Type":"AWS::CloudFormation::Stack",
      "Properties":{
        "TemplateURL":"https://s3.amazonaws.com/stelligent-training-public/public/codepipeline/sns.json",
        "TimeoutInMinutes":"60"
      }
    },
    "S3SNSTopic":{
      "Type":"AWS::SNS::Topic",
      "Properties":{
        "Subscription":[
          {
            "Endpoint":{
              "Fn::Join":[
                "",
                [
                  "arn:aws:lambda:",
                  {
                    "Ref":"AWS::Region"
                  },
                  ":",
                  {
                    "Ref":"AWS::AccountId"
                  },
                  ":function:",
                  {
                    "Fn::GetAtt":[
                      "SNSStack",
                      "Outputs.SNSLambdaFunction"
                    ]
                  }
                ]
              ]
            },
            "Protocol":"lambda"
          }
        ],
        "TopicName":{
          "Fn::Join":[
            "",
            [
              {
                "Ref":"TopicName"
              },
              {
                "Ref":"AWS::StackName"
              }
            ]
          ]
        }
      }
    },
    "MyTopicPolicy":{
      "Type":"AWS::SNS::TopicPolicy",
      "Properties":{
        "PolicyDocument":{
          "Id":"MyTopicPolicy",
          "Version":"2012-10-17",
          "Statement":[
            {
              "Effect":"Allow",
              "Principal":{
                "Service":"s3.amazonaws.com"
              },
              "Action":[
                "SNS:Publish"
              ],
              "Resource":"*",
              "Condition":{
                "ArnLike":{
                  "aws:SourceArn":{
                    "Fn::Join":[
                      "",
                      [
                        "arn:aws:s3:*:*:",
                        {
                          "Ref":"BucketName"
                        }
                      ]
                    ]
                  }
                }
              }
            }
          ]
        },
        "Topics":[
          {
            "Ref":"S3SNSTopic"
          }
        ]
      }
    },
    "CFNBucket":{
      "Type":"AWS::S3::Bucket",
      "DependsOn":"MyTopicPolicy",
      "Properties":{
        "VersioningConfiguration":{
          "Status":"Enabled"
        },
        "AccessControl":{
          "Ref":"AccessControl"
        },
        "BucketName":{
          "Ref":"BucketName"
        },
        "NotificationConfiguration":{
          "TopicConfigurations":[
            {
              "Event":{
                "Ref":"S3Event"
              },
              "Topic":{
                "Ref":"S3SNSTopic"
              }
            }
          ]
        }
      }
    }
  },
  "Outputs":{
    "StackName":{
      "Value":{
        "Ref":"AWS::StackName"
      }
    },
    "OpsWorksBucketName":{
      "Value":{
        "Ref":"BucketName"
      }
    },
    "S3SNSTopicARN":{
      "Value":{
        "Ref":"S3SNSTopic"
      }
    },
    "LambdaARN":{
      "Value":{
        "Fn::Join":[
          "",
          [
            "arn:aws:lambda:",
            {
              "Ref":"AWS::Region"
            },
            ":",
            {
              "Ref":"AWS::AccountId"
            },
            ":function:",
            {
              "Fn::GetAtt":[
                "SNSStack",
                "Outputs.SNSLambdaFunction"
              ]
            }
          ]
        ]
      }
    }
  }
}