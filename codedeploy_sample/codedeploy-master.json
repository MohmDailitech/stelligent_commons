{
  "Description":"Launch nested CloudFormation stack to provision and run AWS CodeDeploy",
  "AWSTemplateFormatVersion":"2010-09-09",
  "Parameters":{
    "LocalBucket":{
      "Type":"String",
      "Description":"The unique bucket name where deployment distribution is located"
    },
    "LocalKey":{
      "Type":"String",
      "Description":"The unique bucket name where deployment distribution is located"
    },
    "LocalTagValue":{
      "Description":"The tag value that identifies this as a target for deployments.",
      "Type":"String",
      "AllowedPattern":"[\\x20-\\x7E]*",
      "ConstraintDescription":"Can contain only ASCII characters."
    },
    "LocalKeyPairName":{
      "Description":"Name of an existing Amazon EC2 key pair to enable SSH or RDP access to the instances.",
      "Type":"AWS::EC2::KeyPair::KeyName",
      "MinLength":"1",
      "MaxLength":"255",
      "AllowedPattern":"[\\x20-\\x7E]*",
      "ConstraintDescription":"Can contain only ASCII characters."
    }
  },
  "Resources":{
    "myStackWithParams":{
      "Type":"AWS::CloudFormation::Stack",
      "Properties":{
        "TemplateURL":"https://s3.amazonaws.com/pmd-cfn/public/codedeploy-three-ec2.json",
        "TimeoutInMinutes":"60",
        "Parameters":{
          "TagValue":{
            "Ref":"LocalTagValue"
          },
          "KeyPairName":{
            "Ref":"LocalKeyPairName"
          }
        }
      }
    },
    "CodeDeploySimpleStack":{
      "Type":"AWS::CloudFormation::Stack",
      "DependsOn":"myStackWithParams",
      "Properties":{
        "TemplateURL":"https://s3.amazonaws.com/pmd-cfn/public/codedeploy-simple.json",
        "TimeoutInMinutes":"60",
        "Parameters":{
          "TagValue":{
            "Fn::GetAtt":[
              "myStackWithParams",
              "Outputs.MyTagValue"
            ]
          },
          "RoleArn":{
            "Fn::GetAtt":[
              "myStackWithParams",
              "Outputs.CodeDeployTrustRoleARN"
            ]
          },
          "Bucket":{
            "Ref":"LocalBucket"
          },
          "Key":{
            "Ref":"LocalKey"
          }
        }
      }
    }
  },
  "Outputs":{
    "StackRef":{
      "Value":{
        "Ref":"myStackWithParams"
      }
    },
    "MyCodeDeployTrustRoleARN":{
      "Value":{
        "Fn::GetAtt":[
          "myStackWithParams",
          "Outputs.CodeDeployTrustRoleARN"
        ]
      }
    }
  }
}